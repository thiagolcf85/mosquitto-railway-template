# HAProxy para balanceamento de carga MQTT com aceleração geográfica
global
    daemon
    maxconn 4096
    log stdout local0 info
    tune.tcp.maxretries 3

defaults
    mode tcp
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout tunnel 3600s

# Frontend para MQTT
frontend mqtt_frontend
    bind *:1883
    mode tcp
    
    # Detectar localização por IP (exemplo básico)
    # Aqui você pode implementar lógica mais complexa
    acl is_local src 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8
    acl is_us_east src_country US
    
    # Roteamento baseado em localização
    use_backend mqtt_cache if is_local
    use_backend mqtt_primary if is_us_east
    default_backend mqtt_accelerated

# Backend cache local (ultra-rápido)
backend mqtt_cache
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    server cache mosquitto-cache:1883 check

# Backend principal Railway
backend mqtt_primary
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    server primary mosquitto-primary:1883 check

# Backend com distribuição inteligente
backend mqtt_accelerated
    mode tcp
    balance leastconn
    option tcp-check
    tcp-check connect
    
    # Prioriza cache local, fallback para primary
    server cache mosquitto-cache:1883 check weight 100
    server primary mosquitto-primary:1883 check weight 50 backup

# Frontend para WebSockets
frontend websocket_frontend
    bind *:9001
    mode http
    
    # Upgrade para WebSocket
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket_connection hdr_beg(Connection) -i upgrade
    
    use_backend websocket_primary if is_websocket is_websocket_connection
    default_backend websocket_primary

backend websocket_primary
    mode http
    balance roundrobin
    option httpchk GET /
    server ws_primary mosquitto-primary:9001 check

# Stats para monitoramento
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE