# Configuração Eclipse Mosquitto com "Acelerador" - Otimizada para Ultra Baixa Latência
# Implementa distribuição geográfica e cache local

# Listeners principais
listener 1883 0.0.0.0
protocol mqtt

listener 9001 0.0.0.0
protocol websockets

# === CONFIGURAÇÕES DE ACELERAÇÃO ===

# 1. Cache local e persistência otimizada
persistence true
persistence_location /mosquitto/data/
autosave_interval 60
autosave_on_changes false

# 2. Conexões bridge para distribuição geográfica
# Bridge para região US-East (principal)
connection bridge_us_east
address switchback.proxy.rlwy.net:34718
topic # both 0 "" ""
bridge_protocol_version mqttv311
bridge_insecure false
bridge_cafile /mosquitto/certs/ca.crt
keepalive_interval 60
restart_timeout 30
threshold 5

# Bridge para cache local (se disponível)
connection cache_local
address localhost:1884
topic cache/# out 0 "" ""
topic live/# in 0 "" ""
bridge_protocol_version mqttv311
keepalive_interval 30

# === AUTENTICAÇÃO ===
allow_anonymous false
password_file /mosquitto/config/password_file

# === OTIMIZAÇÕES DE PERFORMANCE AVANÇADAS ===

# Configurações de rede ultra-otimizadas
set_tcp_nodelay true
max_inflight_messages 200
max_inflight_bytes 0
max_queued_messages 10000
max_queued_bytes 0
queue_qos0_messages true

# Limites de tamanho otimizados
max_packet_size 134217728
memory_limit 1073741824

# Configurações de conexão para alta performance
max_connections -1
sys_interval 10

# WebSocket otimizado
websockets_headers_size 8192

# === CONFIGURAÇÕES DE CACHE/ACELERAÇÃO ===

# Configurações específicas para reduzir latência
per_listener_settings true
max_keepalive 300

# Configurações de retry otimizadas para bridges
retry_interval 10
bridge_max_packet_size 134217728

# === LOGGING PARA MONITORAMENTO ===
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# === CONFIGURAÇÕES DE SEGURANÇA OTIMIZADAS ===
# Permite upgrade de protocolo para WebSockets
websockets_headers_size 8192

# === CONFIGURAÇÕES AVANÇADAS DE PERFORMANCE ===
# Configurações específicas para acelerar pub/sub
clientid_prefixes mosquitto_accelerated_
allow_zero_length_clientid true